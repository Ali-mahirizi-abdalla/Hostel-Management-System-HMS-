{% extends 'hms/base.html' %}
{% load static %}

{% block title %}Kitchen Dashboard - HMS{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .meal-count-card {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 2px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        text-align: center;
        transition: all var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .meal-count-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .meal-count-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(99, 102, 241, 0.3);
    }

    .meal-icon-large {
        font-size: 3rem;
        margin-bottom: var(--spacing-sm);
    }

    .count-number {
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-light), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: var(--spacing-sm) 0;
    }

    .count-label {
        color: var(--text-secondary);
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .count-sublabel {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-top: var(--spacing-xs);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: var(--spacing-lg) 0 var(--spacing-md) 0;
    }

    .auto-refresh-indicator {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--success);
        font-size: 0.9rem;
    }

    .pulse-dot {
        width: 8px;
        height: 8px;
        background: var(--success);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Kitchen Dashboard üë®‚Äçüç≥</h1>
    <p class="page-subtitle">Real-time meal count tracking</p>
</div>

<div class="flex-between mb-3">
    <h2>Overview</h2>
    <div class="auto-refresh-indicator">
        <span class="pulse-dot"></span>
        <span>Auto-refreshing every 30s</span>
    </div>
</div>

<div class="dashboard-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total_students }}</div>
        <div class="stat-label">Total Students</div>
    </div>

    <div class="stat-card">
        <div class="stat-value">{{ students_away }}</div>
        <div class="stat-label">Students Away</div>
    </div>

    <div class="stat-card">
        <div class="stat-value">{{ total_students|add:"-"|add:students_away }}</div>
        <div class="stat-label">Students Present</div>
    </div>
</div>

<!-- Today's Meals -->
<div class="section-header">
    <h2>Today's Meals - {{ today|date:"l, F d" }}</h2>
    <a href="{% url 'hms:daily_report' %}?date={{ today }}" class="btn btn-primary">View Report</a>
</div>

<div class="dashboard-grid" id="todayMeals">
    <div class="meal-count-card">
        <div class="meal-icon-large">üåÖ</div>
        <div class="count-number" id="today-breakfast">{{ today_breakfast }}</div>
        <div class="count-label">Breakfast</div>
        <div class="count-sublabel">8:00 AM - 9:00 AM</div>
        {% if today_early_breakfast > 0 %}
        <div class="mt-2"
            style="padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md);">
            <span style="color: var(--warning);">‚è∞ {{ today_early_breakfast }} need early breakfast</span>
        </div>
        {% endif %}
    </div>

    <div class="meal-count-card">
        <div class="meal-icon-large">‚òÄÔ∏è</div>
        <div class="count-number" id="today-lunch">{{ today_lunch }}</div>
        <div class="count-label">Lunch</div>
        <div class="count-sublabel">12:00 PM - 2:00 PM</div>
    </div>

    <div class="meal-count-card">
        <div class="meal-icon-large">üåô</div>
        <div class="count-number" id="today-supper">{{ today_supper }}</div>
        <div class="count-label">Supper</div>
        <div class="count-sublabel">6:00 PM - 8:00 PM</div>
    </div>
</div>

<!-- Tomorrow's Meals -->
<div class="section-header">
    <h2>Tomorrow's Meals - {{ tomorrow|date:"l, F d" }}</h2>
    <a href="{% url 'hms:daily_report' %}?date={{ tomorrow }}" class="btn btn-secondary">View Report</a>
</div>

<div class="dashboard-grid" id="tomorrowMeals">
    <div class="meal-count-card">
        <div class="meal-icon-large">üåÖ</div>
        <div class="count-number" id="tomorrow-breakfast">{{ tomorrow_breakfast }}</div>
        <div class="count-label">Breakfast</div>
        <div class="count-sublabel">8:00 AM - 9:00 AM</div>
        {% if tomorrow_early_breakfast > 0 %}
        <div class="mt-2"
            style="padding: 0.5rem; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md);">
            <span style="color: var(--warning);">‚è∞ {{ tomorrow_early_breakfast }} need early breakfast</span>
        </div>
        {% endif %}
    </div>

    <div class="meal-count-card">
        <div class="meal-icon-large">‚òÄÔ∏è</div>
        <div class="count-number" id="tomorrow-lunch">{{ tomorrow_lunch }}</div>
        <div class="count-label">Lunch</div>
        <div class="count-sublabel">12:00 PM - 2:00 PM</div>
    </div>

    <div class="meal-count-card">
        <div class="meal-icon-large">üåô</div>
        <div class="count-number" id="tomorrow-supper">{{ tomorrow_supper }}</div>
        <div class="count-label">Supper</div>
        <div class="count-sublabel">6:00 PM - 8:00 PM</div>
    </div>
</div>

<!-- Confirmed Students List -->
<div class="glass-card mt-4">
    <div class="card-header flex-between">
        <h3 class="card-title">Confirmed Students (Today)</h3>
        <div class="flex gap-2">
            <a href="{% url 'hms:export_meals_csv' %}?date={{ today }}" class="btn btn-success">
                üì• Export CSV
            </a>
            <a href="{% url 'hms:early_breakfast_list' %}" class="btn btn-warning">
                ‚è∞ Early Breakfast List
            </a>
        </div>
    </div>
    <div class="card-body" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; color: var(--text-primary);">
            <thead>
                <tr style="border-bottom: 1px solid var(--glass-border); text-align: left;">
                    <th style="padding: 1rem;">Student</th>
                    <th style="padding: 1rem;">Room</th>
                    <th style="padding: 1rem;">Breakfast</th>
                    <th style="padding: 1rem;">Lunch</th>
                    <th style="padding: 1rem;">Supper</th>
                </tr>
            </thead>
            <tbody>
                {% for conf in confirmed_students %}
                <tr style="border-bottom: 1px solid var(--glass-border);">
                    <td style="padding: 1rem;">
                        <div>{{ conf.student.user.get_full_name }}</div>
                        <div class="text-muted" style="font-size: 0.85rem;">{{ conf.student.user.username }}</div>
                    </td>
                    <td style="padding: 1rem;">{{ conf.student.room_number }}</td>
                    <td style="padding: 1rem;">
                        {% if conf.breakfast %}
                        <span class="badge badge-success">Yes</span>
                        {% if conf.early_breakfast_needed %}
                        <span class="badge badge-warning" style="font-size: 0.7rem;">Early</span>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        {% if conf.lunch %}
                        <span class="badge badge-success">Yes</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem;">
                        {% if conf.supper %}
                        <span class="badge badge-success">Yes</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        No meals confirmed for today yet.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh meal counts every 30 seconds
    setInterval(function () {
        refreshMealCounts('{{ today }}', 'today');
        refreshMealCounts('{{ tomorrow }}', 'tomorrow');
    }, 30000);

    function refreshMealCounts(date, prefix) {
        fetch(`{% url 'hms:meal_count_api' %}?date=${date}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById(`${prefix}-breakfast`).textContent = data.breakfast;
                document.getElementById(`${prefix}-lunch`).textContent = data.lunch;
                document.getElementById(`${prefix}-supper`).textContent = data.supper;
            })
            .catch(error => console.error('Error refreshing counts:', error));
    }
</script>
{% endblock %}